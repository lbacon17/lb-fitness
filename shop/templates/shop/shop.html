{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'shop/css/shop.css' %}">
{% endblock %}

{% block content %}
    <div class="container-fluid mt-5 text-center">
        <div class="row">
            <div class="col-12">
                <h1>
                    All Products
                </h1>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1>Favourites: {% for favourite in favourites %}{{ favourite }}{% endfor %}</h1>
            </div>
        </div>
    </div>
    <div class="container-fluid sorting-container">
        <div class="row mt-3 px-3 text-center text-left-sm">
            <div class="col-12">
                <select class="custom-select-sm btn-sm border-black" id="sort-products">
                    <option value="reset" {% if sort_by == 'None_None' %}selected{% endif %}>
                        Sort by...
                    </option>
                    <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>
                        Name (A-Z)
                    </option>
                    <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>
                        Name (Z-A)
                    </option>
                    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>
                        Price (low to high)
                    </option>
                    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>
                        Price (high to low)
                    </option>
                    <option value="rating_asc" {% if sort_by == 'rating_asc' %}selected{% endif %}>
                        Rating (low to high)
                    </option>
                    <option value="rating_desc" {% if sort_by == 'rating_Desc' %}selected{% endif %}>
                        Rating (high to low)
                    </option>
                </select>
                {% if request.user.is_superuser %}
                    <p class="mt-3 mt-sm-0 d-sm-inline-block">
                        <a href="{% url 'add_item' %}" class="btn-lg btn-success text-dec-none">
                            <span>Add Item</span>
                        </a>
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="container-fluid px-5 my-3">
        {% if shop_items|length == 0 %}
            <div class="row">
                <div class="col-12">
                    <h4>No items found for "{{ search_term }}"</h4>
                </div>
            </div>
        {% endif %}
        <div class="row">
            {% for item in shop_items %}
                <div class="col-sm-6 col-lg-4 col-xl-3">
                    <div class="h-100 item-specs-container p-2">
                        {% if item.image %}
                            <a href="{% url 'item_info' item.id %}">
                                <img src="{{ item.image.url }}" alt="{{ item.friendly_name }}" class="img-thumbnail">
                            </a>
                        {% else %}
                            <a href="{% url 'item_info' item.id %}">
                                <img src="{{ MEDIA_URL }}noimage.png" alt="{{ item.friendly_name }}" class="img-thumbnail">
                            </a>
                        {% endif %}
                        <div class="pt-3 font-weight-bold">
                            <p class="mb-0">{{ item.friendly_name }}</p>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p class="lead mb-0 text-left">
                                    {% if request.user.member.subscription_package.id == 3 %}
                                        <strike>£{{ item.price }}</strike> £{{ item.set_discount_price|floatformat:2 }}
                                    {% else %}
                                        £{{ item.price }}
                                    {% endif %}
                                </p>
                                <p class="mb-0">Category:
                                    <a href="{% url 'shop' %}?category={{ item.category.name }}">
                                        <small class="font-weight-bold">{{ item.category.friendly_name }}</small>
                                    </a>
                                </p>
                                <p class="mb-0">Rating: 
                                    {% if item.rating %}
                                        <small>{{ item.rating }} / 5</small>
                                    {% else %}
                                        <small>No rating yet</small>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if request.user.is_superuser %}
                            <div class="text-center py-3">
                                <a href="{% url 'edit_item' item.id %}" class="btn btn-primary mr-1">
                                    <span class="text-white">
                                        Edit Details
                                    </span>
                                </a>
                                {% include 'shop/includes/delete_item_modal_popup.html' %}
                            </div>
                        {% endif %}
                        <div class="row">
                            <div class="col">
                                <form action="{% url 'add_item_to_cart' item.id %}" class="form text-center" method="POST">
                                    {% csrf_token %}
                                    {% if item.has_sizes %}
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>Select Size:</strong>
                                                <select name="item_size" id="id_item_size_{{ item.id }}" class="w-50">
                                                    <option value="xs">XS</option>
                                                    <option value="s">S</option>
                                                    <option value="m" selected>M</option>
                                                    <option value="l">L</option>
                                                    <option value="xl">XL</option>
                                                </select>
                                            </div>
                                        </div>
                                {% endif %}
                                    <div class="row">
                                        <div class="col-md-6 float-right">
                                            <input type="submit" class="btn btn-dark text-dec-none {% if not request.user.is_superuser %}my-3{% endif %}" value="Add To Cart">
                                        </div>
                                        <div class="col-md-6 float-left">
                                            <div class="row input-group">
                                                <div class="col">
                                                    <div class="input-group-prepend">
                                                        <button class="decrease-qty btn rounded-0" data-item_id="{{ item.id }}" id="decrease-qty_{{ item.id }}">
                                                            <i class="fas fa-minus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <input type="number" class="form-control qty_input" name="quantity" value="1" min="1" max="100" data-item_id="{{ item.id }}" id="id_qty_{{ item.id }}">
                                                </div>
                                                <div class="col">
                                                    <div class="input-group-append">
                                                        <button class="increase-qty btn rounded-0" data-item_id="{{ item.id }}" id="increase-qty_{{ item.id }}">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" name="redirect_url" value="{{ request.path }}">
                                </form>
                            </div>
                        </div>
                        {% if user.is_authenticated %}
                            <div class="row">
                                <div class="col">
                                    <form action="{% url 'favourite_item' item.id %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" class="favourite-item">
                                            <i class="far fa-heart"></i>
                                        </button>
                                        <input type="hidden" name="redirect_url" value="{{ request.path }}">
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{% include 'shop/includes/adjust_quantity_script.html' %}
{% if request.user.is_superuser %}
    {% for item in shop_items %}
        {% include 'shop/includes/delete_confirmation_script.html' %}
    {% endfor %}
{% endif %}
    <script type="text/javascript">
        // enables product sorting. Credit to Boutique Ado project for this code
        $('#sort-products').change(function() {
            var selector = $(this);
            var currentUrl = new URL(window.location);

            var selectedVal = selector.val()
            if (selectedVal != "reset") {
                var sort = selectedVal.split("_")[0] // "price etc."
                var direction = selectedVal.split("_")[1]; // "asc" or "desc"

                currentUrl.searchParams.set("sort", sort); // sort=price
                currentUrl.searchParams.set("direction", direction); //direction=asc

                window.location.replace(currentUrl);
            } else {
                currentUrl.searchParams.delete("sort");
                currentUrl.searchParams.delete("direction");

                window.location.replace(currentUrl);
            }
        });
    </script>
    <script type="text/javascript">
        // Increases quantity
        $('.increase-qty').click(function(e) {
            e.preventDefault();
            var closestInputElement = $(this).closest('.input-group').find('.qty_input')[0];
            var currentQuantity = parseInt($(closestInputElement).val());
            $(closestInputElement).val(currentQuantity + 1);
            var itemId = $(this).data('item_id');
        });

        // Decreases quantity
        $('.decrease-qty').click(function(e) {
            e.preventDefault();
            var closestInputElement = $(this).closest('.input-group').find('.qty_input')[0];
            var currentQuantity = parseInt($(closestInputElement).val());
            $(closestInputElement).val(currentQuantity - 1);
            var itemId = $(this).data('item_id');
        });

        // Disables +/- buttons outside the min-max range
        function disableQuantityInput(itemId) {
            var currentQuantity = parseInt($(`#id_qty_${itemId}`).val());
            var disableDecrease = currentQuantity < 2;
            var disableIncrease = currentQuantity > 98;
            $(`#decrease-qty_${itemId}`).prop('disabled', disableDecrease);
            $(`#increase-qty_${itemId}`).prop('disabled', disableIncrease);
        }

        var allQtyInputs = $('.qty_input');
        for (var i = 0; i < allQtyInputs.length; i++) {
            var itemId = $(allQtyInputs[i]).data('item_id');
            disableQuantityInput(itemId);
        }

        // Checks in real time if button should be disabled whenever user changes input
        $('qty_input').change(function() {
            var itemId = $(this).data('item_id');
            disableQuantityInput(itemId);
        });
    </script>
{% endblock %}